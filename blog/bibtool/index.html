<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Agustín Mista">
	<meta name="robots" content="index, follow">
	<meta name="Description" lang="en" content="Personal page">

	<link rel="shortcut icon" href="../../assets/img/favicon.ico">
	<link rel="stylesheet" href="../../css/style.css">

	<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
	<script async src="../../js/index.js"></script>

	<title>Agustín Mista</title>
</head>

<body>

	<header class="container">
		<nav>
			<ul>
				<li>
					<hgroup>
						<h2><a href="../../">Agustín Mista</a></h2>
						<h3>
							<i>
								// Ph.D. Student at Chalmers<br />
								// Lead Software Engineer at DPella
							</i>
						</h3>
					</hgroup>
				</li>
			</ul>
			<ul>
				<li>
					<a class="primary" id="burger">
						<svg viewBox="0 0 100 80" width="40" height="40">
							<rect width="100" height="20" rx="10"></rect>
							<rect y="30" width="100" height="20" rx="10"></rect>
							<rect y="60" width="100" height="20" rx="10"></rect>
						</svg>
					</a>
				</li>
			</ul>
		</nav>

		<div class="grid" id="links" style="display: none;">
			<button class="outline" onclick="window.location.href='/pubs'">Publications</button>
			<button class="outline" onclick="window.location.href='/blog'">Blog</button>
			<button class="outline" onclick="window.location.href='/teaching'">Teaching</button>
			<button class="outline" onclick="window.location.href='/contact'">Contact</button>
		</div>

	</header>

	<main class="container">
		<article>
  <header>
    <h2>Dusting the bookshelf</h2>
    <p>Posted on 2022-11-30 </p>
  </header>

  <section>
    <p>I’m currently in the process of writing my Ph.D. thesis. This means I need to gather all my published papers and fight against LaTeX and Lhs2TeX until everything fits together and looks somewhat decent. One of the many challenges of this process was to deal with the multiple bibliography (<code>.bib</code>) files I collected over the years. Hopefully I’m not the only one in this situation:</p>
<ul>
<li>Paper <span class="math inline">0</span>: inherit a gigantic <code>.bib</code> from advisor and add new references as needed</li>
<li>Paper <span class="math inline"><em>n</em></span>: pick the <code>.bib</code> from some paper <span class="math inline"><em>k</em></span> (with <span class="math inline">0 ≤ <em>k</em> &lt; <em>n</em></span>) and add new references as needed</li>
</ul>
<p>So here I was, sitting with ~50kLOC worth of <code>.bib</code> files I needed to organize. On the other hand, I wanted to collect all the references in a single section of the thesis to avoid repetetition and inconsistencies. So, in principle I could have simply used the good ’ol <code>bibtool</code> utility to merge all my <code>.bib</code> files together:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> bibtool <span class="at">-s</span> foo.bib bar.bib baz.bib</span></code></pre></div>
<p>The problem with this approach is that I would have ended up again with a gigantic <code>.bib</code> file when, in reality, I only needed a handful of entries from it. To solve this, I put together a small bash script that pulls references from <code>.bib</code> files on demand. The trick is to ask for forgiveness rather than for permission:</p>
<ol type="1">
<li>Compile the project with an empty <code>.bib</code> file</li>
<li>Parse the log file to find which citations are missing references</li>
<li>Extract each of those references from some existing <code>.bib</code> file and append them to the project’s <code>.bib</code> file</li>
<li>Compile the project again, now without missing references :D</li>
</ol>
<h2 id="finding-missing-citations">Finding missing citations</h2>
<p>If we inspect the log files created by <code>pdflatex</code>/<code>bibtex</code>, missing citations are reported as:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">LaTeX</span> Warning: Citation <span class="st">'afl'</span> on page 21 undefined on input line 16664.</span></code></pre></div>
<p>So we need to find these warnings, extract the citation keys (i.e., <code>afl</code> in the line above) from them and remove any duplicates:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">LOGFILE</span><span class="op">=</span>thesis.log</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">MISSING</span><span class="op">=</span><span class="va">$(</span> <span class="dt">\</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grep</span> <span class="st">&quot;LaTeX Warning: Citation&quot;</span> <span class="va">$LOGFILE</span> <span class="kw">|</span><span class="dt">\</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">awk</span> <span class="at">-F</span><span class="st">' '</span> <span class="st">'{print $4}'</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="dt">\'</span> <span class="kw">|</span><span class="dt">\</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">uniq</span> <span class="dt">\</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="va">)</span></span></code></pre></div>
<p>With the culprits at hand, we can move onto the next step.</p>
<h2 id="retrieving-citations-on-demand">Retrieving citations on demand</h2>
<p>To find if a concrete reference exists in a given citation file, we can use <code>bibtool</code>’s <code>select</code> resource:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find_ref ()</span> <span class="kw">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">bibtool</span> <span class="at">-q</span> <span class="at">-r</span> biblatex <span class="st">'--expand.macros=ON'</span> <span class="st">'--print.all.strings=OFF'</span> <span class="st">'--select{$key &quot;'</span><span class="va">$1</span><span class="st">'&quot;}'</span> <span class="va">$2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>This way, <code>find_ref $key $bibfile</code> will try to find the reference <code>$key</code> in the file <code>$bibfile</code>, returning either its corresponding entry if it can find it, or an empty string otherwise. The <code>-r biblatex</code> option is needed to allow indexing <code>@online</code> entries, whereas the <code>expand.macros</code> and <code>print.all.strings</code> options are needed to ensure that string macros are expanded, so we don’t need to print them everytime we look for a citation key.</p>
<p>Then, we can iterate over the existing <code>.bib</code> files to see if we find each missing citation:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="va">BIBFILES</span><span class="op">=</span><span class="va">$(</span><span class="fu">ls</span> bib/<span class="pp">*</span>.bib<span class="va">)</span> <span class="co"># Existing .bib files</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">OUTPUT</span><span class="op">=</span>references.bib <span class="co"># The project's .bib file</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> missing <span class="kw">in</span> <span class="va">$MISSING</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="at">-n</span> <span class="st">&quot;Looking for </span><span class="va">$missing</span><span class="st">: &quot;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference is already there</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">FOUND</span><span class="op">=</span><span class="va">$(</span><span class="ex">find_ref</span> <span class="va">$missing</span> <span class="va">$OUTPUT)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">$FOUND</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Already in in </span><span class="va">$OUTPUT</span><span class="st">!&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference is in some .bib file</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> bibfile <span class="kw">in</span> <span class="va">$BIBFILES</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">FOUND</span><span class="op">=</span><span class="va">$(</span><span class="ex">find_ref</span> <span class="va">$missing</span> <span class="va">$bibfile)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">$FOUND</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;Found in </span><span class="va">$bibfile</span><span class="st">!&quot;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$FOUND</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> <span class="va">$OUTPUT</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">done</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference is M.I.A.</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">$FOUND</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Could not find any entry!&quot;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>The reason we first look in the project’s <code>.bib</code> file is to avoid producing duplicate entries when:</p>
<ul>
<li>The user already added them manually, or</li>
<li>We have an overlapping entry key that matches a previously searched missing reference. <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
</ul>
<h2 id="trying-it-out">Trying it out</h2>
<p>We can now run this little snippet to gather only the references we need:</p>
<pre><code>Looking for afl: Found in bib/foo.bib!
Looking for asan: Found in bib/bar.bib!
Looking for peach: Found in bib/baz.bib!
...</code></pre>
<p>And my curated <code>.bib</code> file now has “only” a little over 2000 lines of code ¯\_(ツ)_/¯</p>
<p>You can find the bash script <a href="../assets/code/find_references.sh">here</a> in case you want to give it a try.</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>This happens because <code>bibtool</code>’s <code>select</code> resource looks for <strong>all</strong> the entries whose keys <strong>contain</strong> the given key string. So, for instance, both keys <code>foo</code> and <code>foobar</code> will match with <code>foo</code>, possibly returning more than one entry per <code>find_ref</code>. If you know how to avoid this, please let me know!<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
  </section>

  <footer>
    <h2>Comments</h2>
    <script src="https://utteranc.es/client.js" repo="agustinmista/website" issue-term="pathname" label="post" theme="dark-blue" crossorigin="anonymous" async>
    </script>
  </footer>
</article>
	</main>

	<footer class="container">
		<small>
			Built using
			<a href="https://jaspervdj.be/hakyll">Hakyll</a> and
			<a href="https://picocss.com/">Pico</a> •
			<a href="https://github.com/agustinmista/website">Source code</a>
		</small>
	</footer>

</body>

</html>